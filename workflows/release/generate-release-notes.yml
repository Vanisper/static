# æ­¤ Release å·¥ä½œæµç”¨äºç”Ÿæˆå‘ç‰ˆè¯´æ˜
# ç›‘å¬ä»¥ v å¼€å¤´çš„ tagï¼Œæå–å¹¶åˆ†ç±»æäº¤æ¶ˆæ¯ï¼Œç”Ÿæˆå‘ç‰ˆè¯´æ˜ï¼Œå†™å…¥åˆ° changelog.md æ–‡ä»¶ä¸­ï¼Œæœ€åå¼•ç”¨ changelog.md åˆ›å»ºå‘ç‰ˆ
# ---
# æ¯”è¾ƒæœ‰ç‰¹ç‚¹çš„æ˜¯ï¼Œæœ¬å·¥ä½œæµå…¼å®¹å¤„ç†äº†å¸¦æœ‰ ` å­—ç¬¦çš„ commit-msg
# å› ä¸º github-action çš„å¤§å¤šæ•°æ“ä½œæ˜¯åœ¨ shell ä¸­è¿›è¡Œçš„ï¼Œshell ç¯å¢ƒä¸­ ` æ˜¯ç‰¹æ®Šå­—ç¬¦ï¼ˆå­—ç¬¦ä¸²ä¼šè¢«è¯†åˆ«æˆå‘½ä»¤æ‰§è¡Œï¼‰ï¼Œéœ€è¦è½¬ä¹‰å¤„ç†
# é€šè¿‡ sed 's/`/\\\`/g' å°† ` è½¬ä¹‰ä¸º \`
# å¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªåœ°æ–¹éƒ½æœ‰åšè¿™ä¸ªå¤„ç†ï¼Œè¿™æ˜¯ç”±äºè½¬ä¹‰è¿‡åçš„å­—ç¬¦ä¸²åœ¨â€œä¼ é€’â€è¿‡ç¨‹ä¸­ï¼Œä¼šé€å±‚è¿˜åŸï¼Œæ‰€ä»¥éœ€è¦å¤šæ¬¡è½¬ä¹‰
# ---
# ä½¿ç”¨æœ¬å·¥ä½œæµ commit-msg å°±å¾—éµå¾ª Conventional Commits è§„èŒƒ <https://www.conventionalcommits.org/zh-hans/v1.0.0/>

name: Release

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'  # ç›‘å¬ä»¥ v å¼€å¤´çš„ tag

jobs:
  build:
    name: æ„å»ºå¹¶å‘ç‰ˆ
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è·å–å½“å‰å’Œä¸Šä¸€ä¸ªæ ‡ç­¾
        id: get_tags
        run: |
          git fetch --prune --unshallow
          tags=($(git tag -l --sort=-version:refname))
          current_tag=${tags[0]}
          previous_tag=${tags[1]}
          echo "previous_tag=$previous_tag" >> $GITHUB_OUTPUT
          echo "current_tag=$current_tag" >> $GITHUB_OUTPUT

      - name: æå–å¹¶åˆ†ç±»æäº¤æ¶ˆæ¯
        id: extract_commit_messages
        run: |
          set -e
          current_tag="${{ steps.get_tags.outputs.current_tag }}"
          previous_tag="${{ steps.get_tags.outputs.previous_tag }}"
          if [ -z "$previous_tag" ]; then
            commit_messages=$(git log --pretty=format:"%s - by @%an (%h)" "$current_tag" | grep -E 'feat|fix|docs|perf' || true)
          else
            commit_messages=$(git log --pretty=format:"%s - by @%an (%h)" "$previous_tag".."$current_tag" | grep -E 'feat|fix|docs|perf' || true)
          fi

          # è½¬ä¹‰ ` å­—ç¬¦
          commit_messages=$(echo "$commit_messages" | sed 's/`/\\\`/g')

          {
            echo 'feat_messages<<EOF'
            echo "$commit_messages" | grep 'feat' || true
            echo 'EOF'
          } >> $GITHUB_OUTPUT
          {
            echo 'fix_messages<<EOF'
            echo "$commit_messages" | grep 'fix' || true
            echo 'EOF'
          } >> $GITHUB_OUTPUT
          {
            echo 'docs_messages<<EOF'
            echo "$commit_messages" | grep 'docs' || true
            echo 'EOF'
          } >> $GITHUB_OUTPUT
          {
            echo 'perf_messages<<EOF'
            echo "$commit_messages" | grep 'perf' || true
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: è·å–å½“å‰åˆ†æ”¯å
        id: get_branch_name
        run: |
          branch_name=$(git rev-parse --abbrev-ref HEAD)
          echo "branch_name=$branch_name" >> $GITHUB_OUTPUT

      - name: å‘ç‰ˆè¯¦æƒ…
        id: generate_release_notes
        run: |
          # æå–æäº¤æ¶ˆæ¯åˆ†ç±»
          feat_messages=("${{ steps.extract_commit_messages.outputs.feat_messages }}")
          fix_messages=("${{ steps.extract_commit_messages.outputs.fix_messages }}")
          docs_messages=("${{ steps.extract_commit_messages.outputs.docs_messages }}")
          perf_messages=("${{ steps.extract_commit_messages.outputs.perf_messages }}")

          release_notes=""

          if [[ -n "$feat_messages" ]]; then
            release_notes="$release_notes\n### ğŸš€ Features æ–°åŠŸèƒ½:  \n"
            while IFS= read -r message; do
              release_notes="$release_notes\n- $message"
            done <<< "$feat_messages"
          fi

          if [[ -n "$fix_messages" ]]; then
            release_notes="$release_notes\n### ğŸ©¹ Fixes ç¼ºé™·ä¿®å¤:  \n"
            while IFS= read -r message; do
              release_notes="$release_notes\n- $message"
            done <<< "$fix_messages"
          fi

          if [[ -n "$docs_messages" ]]; then
            release_notes="$release_notes\n### ğŸ“– Documentation æ–‡æ¡£:  \n"
            while IFS= read -r message; do
              release_notes="$release_notes\n- $message"
            done <<< "$docs_messages"
          fi

          if [[ -n "$perf_messages" ]]; then
            release_notes="$release_notes\n### ğŸ”¥ Performance æ€§èƒ½ä¼˜åŒ–:  \n"
            while IFS= read -r message; do
              release_notes="$release_notes\n- $message"
            done <<< "$perf_messages"
          fi

          # è½¬ä¹‰ ` å­—ç¬¦
          release_notes=$(echo "$release_notes" | sed 's/`/\\\`/g')
          echo "release_notes=$release_notes" >> $GITHUB_OUTPUT

      - name: å†™å…¥ç”Ÿæˆçš„å‘å¸ƒè¯´æ˜åˆ° changelog.md
        run: |
          echo -e "${{ steps.generate_release_notes.outputs.release_notes }}" > changelog.md
          cat changelog.md

      - name: å¼•ç”¨ changelog.md åˆ›å»ºå‘ç‰ˆ
        id: release_tag
        uses: ncipollo/release-action@v1.14.0
        with:
          bodyFile: changelog.md
